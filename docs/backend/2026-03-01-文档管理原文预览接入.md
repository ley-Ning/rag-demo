# 2026-03-01 文档管理原文预览接入（后端）

主公，这一版后端把“原文预览”能力补上了，文档管理页现在可以直接看上传的原文件。

## 1. 这次改了哪些文件

1. `python-service/app/api/v1/endpoints/documents.py`

## 2. 实现细节（大白话）

### 2.1 新增原文预览接口

新增接口：

- `GET /api/v1/documents/{document_id}/file`

接口做的事：

1. 先查 `documents` 表，拿 `file_name` 和 `metadata.storagePath`。
2. 校验文件路径必须在上传目录内（防止越权读任意文件）。
3. 校验文件真实存在。
4. 根据后缀推断 `content-type`，按 `inline` 返回给浏览器。

### 2.2 为什么这样设计

- 直接返回原始文件流，PDF/TXT/Markdown 都能原样预览。
- 不强行把所有格式都转文本，避免格式丢失和额外 CPU 开销。
- 前端和 BFF 只要打开这个接口就能预览，联动成本低。

## 3. 小赵两轮思考

### 第一轮：先保证“能看见原文件”

- 用文件流直出最稳，路径最短。
- 先把“预览链路可用”放在第一优先级。

### 第二轮：再补“安全边界”

- 增加 storagePath 的目录归属校验。
- 防止 metadata 被污染后读到上传目录外文件。

## 4. 验证结果

已执行：

- `python3 -m compileall python-service/app/api/v1/endpoints/documents.py`

结果：

- 编译通过。

## 5. 思维导图

```mermaid
mindmap
  root((后端原文预览))
    新增接口
      GET documents/{id}/file
    处理流程
      查文档元数据
      取storagePath
      校验路径归属
      校验文件存在
      inline返回文件流
    价值
      原文不丢格式
      前后端联动简单
      支持常见浏览器预览
    安全
      限制上传目录内访问
```
